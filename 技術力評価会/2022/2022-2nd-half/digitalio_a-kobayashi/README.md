# 「アプリ何もわからない…」サーバーサイドエンジニアが、アプリの機能開発~リリースまでこぎつけた話

- 開催日
  - 10月 31日 (月曜日)⋅午後1:00～2:30
- 評価者
  - 有村 皓太郎さん
  - 小橋 大助さん
- 評価対象者
  - 小林彩花  
  - 所属
    - 株式会社DIGITALIO ポイントメディア事業本部  
  - グレード
    - E2 

## 用語

- ECナビ  
  - https://ecnavi.jp/
  - 運営: 株式会社DIGITALIO
  - アフィリエイトなどでポイントを貯めることが出来るサービス。貯めたポイントはPeXへ交換し各種ギフト券などへ交換可能。

- リサーチパネル
  - https://research-panel.jp
  - 運営: 株式会社リサーチパネル(株式会社CARTA HOLDINGS 60%, 株式会社クロス・マーケティンググループ 40%)
  - ECナビとは別サービス。アンケートを回答してポイントを貯めることが出来る。
貯めたポイントはECナビポイントになるので、ECナビアカウントとリサーチパネルアカウントの紐付けが必要になる。

- アンケートアプリ
  - [app store](https://apps.apple.com/jp/app/%E3%83%9D%E3%82%A4%E6%B4%BB-ec%E3%83%8A%E3%83%93%E3%82%A2%E3%83%B3%E3%82%B1%E3%83%BC%E3%83%88-%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%8C%E8%B2%AF%E3%81%BE%E3%82%8B%E3%81%8A%E5%BE%97%E3%81%AA%E5%89%AF%E6%A5%AD%E3%82%A2%E3%83%97%E3%83%AA/id1467172022)
  - [google play store](https://play.google.com/store/apps/details?id=jp.ecnavi.ecnavienqueteapp.android)
  - ECナビへの流入経路としての位置付けで運営されているアプリ

- CPI案件
  - インストール成果型のリワード広告
  - iOSアプリでは、ランキング操作に当たるとしてアプリ内でのCPI案件の掲載が許可されていない。

## 体制

- iOSアプリの開発は数年前で止まっていた
- アンケートアプリチームは現在解散し、新規開発することはない状況だった。  
リリースタイミングとしては、定期的なパッケージアップデートのみで決められた作業フローを行うのみの対応になっていた。
- そのため知見があるメンバーが残っておらず、何もわからないからのスタートだった

- 関わった人
  - 私
    - 今回開発を行った
    - Appleとのやり取り・交渉を行った
    - 対応の方針を決めた。やる/やらない等
    - 下記に記載のメンバー, 所属チーム(`@g_pm_engineer_t`)へのスケジュールの管理・共有を行った
  - りゅう(`@ryu`)
    - 元アプリチームのメンバーでAndroidの開発を行った。方針などの相談をした。
  - ゆきみねさん(`@yukimine`), かいくん(`@かいくん`)
    - 元アプリチームのメンバーでiOSの開発を行っていた。
    - 今回何度も相談に乗ってもらっており、一緒にコードリーディングしたりアプリの概要を教わった。
  - 増井さん(`@増井俊資 Shunsuke Masui`), 米村さん(`@yasutaka_yonemura`)
    - アンケートアプリの運用を行っている。
    - ASO対策でiOSのリリースを行いたい要望があった。

## 背景

定期的に行っているアプリのパッケージアップデートを行う際に、Appleの審査で落ちてしまったのが戦いの始まりだった。  
新規で開発を行っていないアプリで審査が落ちた為、チームが解散し知見がある人がいない&開発全く何もわからないという状況で、審査で指摘されていることについて調査・対応をする運びとなった。  

### 指摘を受けた物
#### ①アカウント削除機能(退会)に関して  
https://developer.apple.com/jp/support/offering-account-deletion-in-your-app/  
> 2022年6月30日以降、アカウント作成に対応しているAppは、App Store Reviewガイドライン5.1.1(v)の記載に従い、ユーザー自身がApp内でアカウントを削除できるようにする必要があります。

以前からずっと話がでていたけど、延期されていたガイドラインが正式に制定された。  
アカウント作成を行っているアンケートアプリではアカウント削除機能がなく、ガイドラインに沿ってなかった為、対応は必要だった。  

#### ②Sign in with Appleで会員登録時に氏名の入力補完をする件に関して  
https://developer.apple.com/app-store/review/guidelines/#4.8  

ガイドラインに記載は機能が提供されていることであり、氏名の入力補完が必須という項目がないように見え何度か質問の応答を繰り返した。
だが、審査員からはAPIのリファレンスやガイドラインのURLしか返ってこなかったため対応の必要が出た。

#### ③プライバシーポリシー
[Guideline5.1.1　- Legal - Privacy ](https://developer.apple.com/app-store/review/guidelines/#5.1.1)　でも落ちた。  

生年月日・性別・郵便番号はコア機能に不要なものを収集しているので削除するか、optionにしてください、という指摘だった。   
ECナビではコア機能であるアンケートを配信するために属性を利用しているのでGuidelineには違反してないと[返答し](https://github.com/voyagegroup/ecnavi-enquete-app/issues/782#issuecomment-1284892286)納得してもらえ、開発対応は不要になった。  


## 機能改修

指摘を受けた①②をやることにし、機能開発を進めていった。

### アプリ内にECナビのアカウント削除機能(退会)を追加する

https://user-images.githubusercontent.com/39899014/184607671-ba9072d0-0607-44fa-bd31-914d51fc3ce4.mov

- 修正した仕様
  - 下記一連の動作の作成  
アプリ内の設定 > 退会 > （ECナビ退会ページ） > 退会のアラート確認　> 退会完了 > ログイン/会員登録ページへ戻る   
- 対応した理由
  - アプリ内でアカウント作成機能があるアプリは作成された該当アカウントの削除機能もないといけない、というガイドラインは前から制定されていた。
  - 既存で設定→ヘルプ→(外部ブラウザに飛ぶ)→一番下に退会はこちら的なリンクが有るので押す→退会ページ という動線があった。    
  これで審査で突かれたということは、アカウント削除がアプリ内の機能としてないとして突かれたということだと判断した。    
  そのためアプリ内で、ECナビの退会を出来るようにした。    
  - やらなかったこと
    - リサーチパネルの退会ページにECナビの退会ページを貼ることはしない([参考](https://github.com/voyagegroup/ecnavi-enquete-app/pull/773#issuecomment-1202212147)
      - リサーチパネルを使わなくてもECナビを使うケースはある。  
      - ECナビを使わずにリサーチパネルを使うことは可能ではあるが、ポイントの交換ができなくなるので機能しなくなる。   
        では、ECナビを退会した時リサーチパネルのアカウントも同期して退会させるかというと、それぞれは違う運営のサービスとしているのでそこまでする権限がECナビにないと判断した。

- app PR: https://github.com/voyagegroup/ecnavi-enquete-app/pull/773
  - アプリの一連の画面の流れと、アラートを作った。
- ecnavi PR: https://github.com/voyagegroup/ecnavi/pull/14529
  - CPI案件へ動線がつながってしまうとして、ヘッダーやフッダーを出さないようにするアンケートアプリ専用のviewを作成した。
- ecnavi PR: https://github.com/voyagegroup/ecnavi/pull/14631
  - ECナビの退会ページにリサーチパネルの退会ページへの動線を作った。
  - アプリだけでなくwebにも影響するが、リサーチパネルはECナビがないと利用できないのでどの動線からでも退会ページへのリンクを貼る修正を加えた。
  

### Sign in with Appleで会員登録時に氏名の入力補完をする

<img width="786" alt="image" src="https://user-images.githubusercontent.com/39899014/197082101-d93d81c2-4395-4e91-aa5d-731fdae35a78.png">

- 修正した仕様
  - 下記一連の動作の作成
Sign in with Appleを利用しての会員登録 > (FirebaseからApple認証で提供される氏名を取得) > (仮登録テーブルに氏名保存) > 会員情報入力ページにて氏名の補完
- 理由
  - 審査時に指摘された動作をそのまま再現できるように修正を行った。
  - 氏名は現状Appleの初回認証でしか得られないので、取得できる際のみ入れるようにした。
- 対応しなかったもの
  - 会員登録後にECナビのDBへ氏名が入らない
    - 今回だけでなく、既存のバグだった。
    - 今回の第1目標はiOSアプリがリリースまでイケる状態まで持っていくことであり、更にこの部分に関してはwebの修正なので今回のスコープからは一旦外した。  
    - とはいえ不具合なので（現状困った声は上がっていないが、）[issue](https://github.com/voyagegroup/ecnavi/issues/14951)を切って対応していく。  
  - Apple以外SNS認証を新しくつなぎこむことになったときのことは考慮しなかった。      
    そのような予定は現状ない上に、考慮を含むとより開発スピードが落ちると思ったので現時点での状況にだけ合わせて対応した。



- issue: https://github.com/voyagegroup/ecnavi-enquete-app/issues/782
- ecnavi PR: https://github.com/voyagegroup/ecnavi/pull/14835
  - appleから氏名を取得するようにfirebase scopeの設定をした
  - 取得してきた氏名をリサーチパネルに送るようにした
- research PR: https://github.com/voyagegroup/research/pull/1435
  - 氏名が送られてきた場合仮会員テーブルに指名が入るようにした
  - 入ってる仮会員テーブルから氏名も取得できるようにした
  - 取得した氏名を会員情報入力ページにて入力補完させるのに利用した


### スケジュール

- 7月スタート
- アプリ内にECナビのアカウント削除機能を追加する
  - 2ヶ月
- Sign in with Appleで会員登録時に氏名の入力補完をする
  - 1.25ヶ月

- 時間がかかってしまった理由
  - 間にTreasureが入って全く触れない期間があった
  - チームに投げられる他タスクも平行してやっていた
  - OJTとして2人の内定者アルバイトを見ていた
  - なれないswift, ほぼ初めて触るProjectでキャッチアップに時間がかかった
- 進め方で工夫した点
  - 現状どのくらい進んでいるのか、あとどんな作業が残っているのかという全体感の共有をPJメンバー、所属チームにこまめに行なった
  - 詰まったり、詰まりそうになったら分かる人に聞きまくった
  - 下手に記事などに手を出さず公式のドキュメントを見漁った

### 結果/評価してほしいポイント

- 審査を無事passした！！ ほぼ初のアプリ開発やり終えた。
- 認証周りの構成に関して知識の継承を受け継ぐことができた。  
  - ここに関してはまだ次の継承に繋げるムーブをできていないが、今後の展望としてやっていきたい気持ちを持った。
- 審査結果に対してどのように対応対応するかの方針を相談の上考え、主体的に開発・Appleとの交渉を行い、中には交渉の結果対応不要になったものも出た。
  - 具体的に: 審査員からのFBを受け、指摘内容に対する現状の調査、どうやったら対応範囲が減るかを考え、必要に応じてPJメンバーへ相談した上で、Appleへの返信を行ったり開発を行った。
  - NO開発で対応不要にさせ、省エネでバリューを発揮したい強い気持ちを持って粘った。
- 結果的に時間がかかってしまったが、オープンにして進捗状況を共有していたので何やってるんだろう？どうなってるんだろう？という状況は避けられた。
- サービス/チームを跨いでヘルプを出し巻き込んでいけた。
  - ネイティブアプリ/ecnavi/researchを跨いだシステムの理解を進めた。
  - 経験のあるゆきみねさん/かいくんに相談し、もうどうにもならん！を回避した。

### 今後の展望

- iOSアプリのリリースが行える状況になった。
- 処理がややこしいので今後は図などに起こして誰でも入りやすい状況に持っていき、現チームメンバーも巻き込んでいきたい。
- 認証部分等で、RPやECナビ部分を、APIを作ってもう少しシンプルにしていけたらいいとおもう。

