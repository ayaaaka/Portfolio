# ECナビ 定額アフィリエイト 不正CVポイント付与対策

# 執筆者

小林彩花

所属：株式会社VOYAGE MARKETING ポイントメディア事業本部

グレード: E1

# アピールポイント

- 細かく調査・検証を行った
- 周りの人を巻き込んで色んな角度・視点から案を練った
- 実際の数字ベースでなぜそうなるかを追えるタスクの進め方ができた
- 現状問題なく運用できている

# 概要

ECナビでは過去何度か広告コードの書き換えによる不正CVが発生しポイント付与が起きてしまう事件が起きている。  
そのため多角的なアプローチを行い不正を阻止する方針である。  
その中の一つとして、今回はナビとASP間での不正対策案として考案した。  

ナビでのアフィリエイトの流れは大まかに以下  
![image](https://user-images.githubusercontent.com/39899014/82179556-93230780-9919-11ea-8b8e-5503a4d21065.png)

ECナビにAPIがあり、ASPから情報をのせてリクエストを送ってもらい、ポイント付与している。 = PUSH型

※ 他にクライアント側のサーバー上に成果情報があり、数日に1回取りに行って成果保存するPULL型と呼ばれる形式もあるが、即時性が低いため不正に合うケースが少ない。  
そのため例では上記のPUSH型の例を用いて説明する。

#### 成果通知でASPからくるものの例
`https://ecnavi.jp/eada/point/affiliate_walker/?sid=XXXXXXXX&aid=0001_11111&awprice=324&awid=1234_aw123456&jdtime=2011%2F09%2F13+16%3A26%3A38&actime=2011%2F09%2F13+16%3A26%3A38&acflg=1`  
- ユーザID(sid)
- 広告ID(aid)
- 報酬金額(awprice)
- 成果ID(awid)
- 発生日(jdtime)
- 承認日(actime)
- 承認ステータス(acflg) 発生or承認or否認

# 背景

当時時点で、ECナビのASP繋ぎこみでは、ASP側にはユーザーIDしか渡っていない  
そのため案件のすり替え等による成果の不正が行われる可能性があるので、対策を模索する

<details open><summary>過去にあった不正の例</summary>
   
<br>   

　[当時の資料](https://docs.google.com/document/d/1vYb5pjIl3SVgXBXDN0MUWAgho-Dd4xqlSa1Dmd5iA_0/edit)

1. 不正ユーザーがECナビからASPに高額案件でリダイレクト（このとき送っていた広告IDは高額案件）
2. CV時不正ユーザーが広告IDを書き換え、
3. 即承認案件の成果URLに、高額案件の成果情報を書き換えて不正ユーザーがASPに送る
4. ASP側ではそれを承認データとして認識、そのままECナビに成果通知をする
5. ECナビではその時2つパラメータを渡していた(ユーザーIDと広告ID)。  
このとき来た成果通知自体は無料案件のものだったけれどECナビが付与したパラメータには高額案件の広告IDが入っていた。  
ECナビは高額案件の方の広告IDでポイント付与をしており、ポイント付与されてしまった。  

<div align="center"><img src='https://user-images.githubusercontent.com/39899014/95839898-7da5f280-0d7e-11eb-81c6-759e1a0cde63.jpg'></div>


- その後のナビの対応
  - sadを広告IDとして見ることを辞め、xadを広告IDとして見るようになったので上記の不正の場合高額案件としてポイント付与がされることはなくなった。
  - しかし、成果通知時に、ナビは広告IDが存在するかどうかしか見れていない。  
    そのためもし上記の事が起こった場合、ナビを経由して行ってなくても、**広告ID=111の案件が登録されていればその案件でポイント付与されてしまう**ので対応としては十分とは言えない。

</details>   

# 解決手法

必要条件：　ASPから通知された成果情報が、ナビから遷移した際のデータとして正しいことを担保できること

[関連issue](https://github.com/voyagegroup/ecnavi/issues/9673)

## 案① ランダムな文字列(トラッキングキー)発行&DB保存方式

<details open><summary>詳細</summary>
  
<kbd>![image](https://user-images.githubusercontent.com/39899014/85355590-ebb47880-b547-11ea-9a31-f6f00c18e52b.png)</kbd>

1成果に対して1つ、ユニークになるようなランダムな文字列を生成し、URLに付与してASPに遷移。  
生成したユニークなランダム文字列はDBに保存する  
ASPから届いた成果通知で返ってきた値を、DBから引っ張ってきて案件情報を照合し

- 成果通知で届いた各値の形式などのバリデーションチェック  
- 成果通知で渡ってきたトラッキングキーがDBに存在する
- 成果通知で渡ってきた広告コードとDBに保存した広告コードが同じである  
- 渡ってきたCV日付がDBに保存した渡った日付より遅い  

一致したら正しいCVと認識する方法  


### 検証

#### MAX想定で予想を立てた

- ECナビ→ASPへ渡る総数
  - `830万前後/月`
- 必要なDBリソース/月 
   `830万` × `600byte/レコード` = `約5.01GB/月`
- 案件の寿命
  - 観測できた中で最長「410日前後に承認/非承認」
  - 案件はクライアントによるしどこまで行くかわからないので2年は保持しておくことにした。
- 単純計算でMAXのDBサイズ
  - `5.01GB/月` × `24ヶ月` = `約120GB`

#### トラッキングキーの生成方式を決めて実際に入るデータに近いテストデータを作り検証することにした

【トラッキングキーの生成方法】

```
protected function createTrackingKey(): string
    {
        $data = base64_encode(pack('H*', md5(uniqid(Rand(), true))));
        return str_replace(array('+','/','='), array('-','_',''), $data);
    }
```
💡ちょこっと解説💡

`md5(uniqid(Rand(), true)` までは乱数生成  
`pack('H*', 略` でバイナリに変換  
`base64_encode(` でエンコード  

上記で
- 出力文字もいい感じに出来る
- ランダム制もいい感じにできそう
- 文字数も膨らまなさそう

`str_replace(array('+','/','='), array('-','_',''), $data)`  
上記はPHPの公式がbase64_encodeに対するurlsafeな文字列変換を用意していたので利用

【DBの検証】

 - [約2億件のテストデータを作成](https://github.com/voyagegroup/ecnavi/issues/9673#issuecomment-630569758)
 - [比較した結果](https://docs.google.com/spreadsheets/d/1GeVBWT2AYXfitwwuQFQpCEV2PIo2fO9fo2EZpW9ppFI/edit#gid=0)  
   - 成果通知時に使う予定のtracking_key(ID) を1件selectしたら0.08秒  
     問合せ時に使う可能性が高いuser_idは、結果が数件あって0.05秒  
     値によって多少前後はあるけどデータの取得時間は大体0.1秒未満で、1秒はかからない  
   - テーブル全体で約40GBで、  
     [空き容量は330GB（当時）](https://app.datadoghq.com/dashboard/5u7-vj5-tfy?to_ts=1589956200000&is_auto=false&tpl_var_resourcegroup=ecnavi01&from_ts=1588746600000&live=false&tpl_var_name=ecnavi-mysql-inst1-mstr&page=0)のでサイズは問題なさそうだと判断。

### 判断材料

- メリット
  - ASPに送る値は短く出来る
  - ナビ内で保持するデータが必ず正しい
- デメリット
  - 膨大なデータ量を長期間保存しなければならなく、コストがかかる可能性　
    - そうはいっても..  
       新規ASP繋ぎこみはこの方法で行くが、既存をの提携方式を移行するか未定だったのでMAX想定までいかなさそう  
       &DBの増設が必要あるくらいにはならなさそう

</details>

## 案② データを暗号化して送る方式

<details open><summary>詳細</summary>

[issueのリンク](https://github.com/voyagegroup/ecnavi/issues/9673#issuecomment-595621427)
<img src='https://user-images.githubusercontent.com/39899014/82286954-fb392280-99d9-11ea-8b3c-f7f5d0e114ab.png'>

必要情報（ユーザーID，広告ID, ASP_ID, クリック日時）を元に暗号化し、暗号化したものを付与してASPに遷移。  
ASPから届いた成果通知で返ってきた値を、  
- 復号できる  
- 復号した各値の形式などのバリデーションチェック  
- 成果通知で渡ってきた広告コードと同じである  
- 渡ってきたCV日付が渡った日付より遅い  
- 復号した結果から、保存してあるDBから値が取れた場合（DBのデータは半年後はRedashに移行し削除する）

一致したら正しいCVと認識する方法  

※ 大半の案件は半年以内に成果が返ってくる為、DBは作成し、バックアップとしてRedashに保存、半年後にデータは削除していく運用で行くことに決めた。  
半年以内に成果が返ってきた場合はDBの値を参考に精査を行い、半年以降のものは不正が行われることも少ないと見て切り捨てる判断とした。  

### 検証
- [暗号化・手法などについて調べた](https://github.com/voyagegroup/ecnavi/issues/9673#issuecomment-618752787)  
  現在あるphpで利用できる暗号化方式を調べた  
- 実際に入れる予定のデータを用いて色々な暗号化方式を試した
- 突破されたときのためのversion管理などを考慮  

### 判断材料
- メリット
  - DBに保存しておく必要性がそこまでないのでDBを圧迫しない
- デメリット
  - 暗号化後の文字列の長さがパラメータとして許可されない可能性がある
    - 暗号化した結果は約70文字になってしまい、新しくつなぎこむ予定のASPでもパラメータ長の長さは50文字推奨であったりと厳しかった。
    - 参考としていくつかの既存ASPで、パラメータの最大長が何文字かを確認した所、最小で32文字であった。 
      - 暗号化方式ではそこまで短縮することはほぼ不可能であると判断

</details>

# 方針決定

案① ランダムな文字列(トラッキングキー)発行&DB保存方式 で行くことにした。

【理由】
- ナビから行った確実な証拠が出来るため、最初に記載した不正は防ぐことが出来る
- ASP側の計測ツールの関係上トラッキング漏れが起こってしまうが、その際の調査に役立てることが出来る。  

# 実際に作った物

- [トラッキングデータ保存用DB作成](https://github.com/voyagegroup/ecnavi-db/pull/536)
- [backup用 redshiftにDB作成](https://github.com/voyagegroup/ecnavi-dwh/pull/296)
  - [データ移行設定](https://github.com/voyagegroup/ecnavi-etl/pull/384)
- [パーティション毎に毎月定期削除する設定](https://gitlab.voyagegr.info/ecnavi/antique/merge_requests/586/)

実際に新規ASPとのつなぎ込みが合ったので早速導入もした。

  - [ナビ→ASPへ行くところの処理](https://github.com/voyagegroup/ecnavi/pull/9638)
  - [ASP→ナビへ成果通知するところの処理](https://github.com/voyagegroup/ecnavi/pull/10024)
  - [管理画面修正](https://github.com/voyagegroup/ecnavi/pull/10081)

本番環境でASPに発行してもらったテスト案件で疎通テストをした結果大丈夫そうだった。  

## 現状と今後


現在はこの方法で2つのASPが繋ぎこみされており、今後新しいASPがつなぎこまれる際は必ずこの方式で提携することに決定した。  
既に提携済みのASPに関してはまだ未定だが、可能であればこの方針に沿っていったほうがいいとしている。  

トラッキングキーによる不都合・不具合等なく運用できている。

現状のDBの総件数： 21万件強  
想定よりかなり少ないのは、想定時は全ASPの成果を入れるMAX利用時に張っていたのでかなり下回ってる。  
結果、2年経ったデータを消すようにしているが2億まで入るのはかなり先になりそうと考えている(なんならないかも  
VMでは毎週1回パフォーマンスチェックという会がありDBの余力に関してはそこをみて定期的に確認できる仕組みが既にあるので気づいたら容量いっぱい等にはならない。  

また、成果に関する問い合わせとして「CVしたはずだけどポイントが付与されていない」と言ったようなものが来た場合、それが実際にECナビの該当案件を経由して遷移したかどうかの調査に使えることも出来る。  
実際そういった利用が出来ていて、都度ASPへ聞く必要がなくなったり、聞く必要がある場合でも絞り込みに役立てることで対応コストが下がったと思える。
