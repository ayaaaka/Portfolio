# 技術力評価会 評価結果

- 被評価者: VM 小林 彩花さん
- 評価者: 人事本部 大島

[評価資料](https://github.com/voyagegroup/tech-assessment_22nd/blob/master/22nd-2nd-half/vm_a-kobayashi/README.md)

## 総評

不正対策という大きいテーマでしたが，検討や検証を丁寧に行って進められていました．
外部の制約（パラメータ文字数）や内部の制約（DBや使用技術）から，丁寧に検証を進めていた印象です．

前回もそうでしたが，DB負荷を考え実際にダミーデータを入れながら検証するなど，とても丁寧なお仕事だったと思います．
推測ではなく実際に手を動かして不安をつぶしていくスタイルは，分かってはいるけど中々大変だと思います．
ここはayakaさんの素晴らしいところだと思いますので，これからも引き続き頑張ってください！

ただ不正対策という側面に目を向けると，若干気になる点もありました．

・不正の実態把握とビジネスリスク把握が不十分に感じた

この点は「成長へのアドバイス」で記載しますが，今回は不正対応が目的なので，不正の本質とビジネスリスクについては定量的な説明があるとよかったです．

不正は終わりのない戦いですが，今後も頑張って「ECナビは不正をするコストが高い」と悪意あるユーザに思わせるサービスにしていきたいですね！

## 成長へのアドバイス

#### お仕事を丁寧に進めて行くスキルはバッチリ

前回と同様にお仕事はとても丁寧で，issueのまとめもしっかりしているので安心感がありました．
さらに，検討内容や対応も前回より精度が上がって，評価者として頷けるポイントが多かったです．
与えられた領域をしっかり責任を持って進めることはちゃんと出来ていると思います！

#### 評価会について

今回は2年前に起きた「不正」に対して，当時の問題点を「そのまま解決」する形で対応されていました．
今回の対応で「セレス案件で起きた不正」は防げるようになったので，評価会で説明されたスコープは理解できました！

ただし，不正対策という大きい森が上手く伝わってこなかったため，今回の対応の良し悪しになると判断が難しいところでした．
なので，評価会では「本当に欲しかったモノ」はもう少し検討できたのでないかと感じました．

評価会後のFBで，色々チームで話したり考えたとのことだったので，次回の評価会ではぜひ検討事項や判断の根拠もしっかりお話ししていただけると嬉しいです！

その上で，やはり「不正対策」を軸に考えると，もう一歩踏み込みが欲しいと感じたので，下記に発展アドバイスを載せます．

#### 「不正対策」が目的なので「どうすれば不正を防げるのか」はもう一歩踏み込みたい

ayakaさんが担当する以前に起きた不正なので，分からない箇所が色々あったと思います．
でも不正対策は「隠密中の敵をいかにしてぶん殴るか」なので，未知の不正やASP側の問題は重々理解できますが，大局的な不正対策観を持って進められるとよかったです．

とはいえまだE1の評価会なので，今回だと「技術面を含めた不正の詳細」と，「現状と，起きうるビジネスリスク」はしっかり把握しておきたかったです．
ここを把握しておくと，実はDBにトラッキングログテーブルを導入する前に「もっと浅い一手を打たないとマズイ」といった優先順位が明確になったかもしれません．

以下では，評価会で聞いた話を元に，自分が今回の不正対応をムニャった感じです．

---

文が長いので，まずは不正対策の流れだけ箇条書きします．

* 現時点の不正の実態を調べる
    * そもそも2年前の話なので，現状は知りたい
    * どんな情報を付け合わせて確認するかが肝ですが，そのために不正の仕組み把握が重要になる
    * 調べた結果，残念ながら今も被害を受けていたら，まずはチームに共有
* 不正の仕組みを理解し，その仕組みで起きうる不正パターンは把握する
* 不正の実態と今後起きうる最大の被害を加味して，どこから手を付けるかを考える
    * 最終的に「被害」を最小限に出来ればいいので，システムだけでどうにかしようと考えなくてもOK
    * 不正頻度によっては一次対応スピードが要求される場合もあるので，ここはチーム総力戦になることが多い
* 優先度に応じて対策する
* 不正を定量的に測る仕組みを考える

ここから長い文です．

元々の不正は，ASPのCV時URLパラメータ（xad）を書き換えられてしまう点が問題でした．
今回の対応で，トラッキングログと違うCVパラメータは弾くことが出来るようになりましたが，不正の要因は

```
【前提】
・ASPへ渡したパラメータを，クライアントのサイトまで引き継いで，ECナビのCVに使っている
・パラメータはASPのCV URLに乗せてECナビに返して貰っている
・パラメータは第三者が操作できるけど，ASPの通知を「信じて」運用している

【不正ユーザができること】
・ECナビのCVパラメータをクライアントのサイトで知ることができる
・ASPのCV URLをパラメータを乗せ換えて叩くことができる
```

のように見えたので，別の対策も考えないと `同系統の不正が起きる可能性があります` ．

```
【例えば．．．】
1. 不正ユーザは高額案件のクリックを行い，トラッキングパラメータを取得
2. 不正ユーザが低額案件のクリックからCVまで行い，ASPのCV通知に高額案件のトラッキングパラメータを挿入
3. 高額案件のトラッキングログとCV通知のトラッキングパラメータが一致するので，正しいCVになる
```

なので「不正ユーザがECナビで使うCV用パラメータを操作できる」にどうアプローチするかが，今回の肝だったと感じました．
そもそもASPから渡ってくる値は，上記から「信用できない」値なので，信じるしかない前提は忘れる必要があります．

一案としては，ECナビ案件とASP案件のCVマッチングは「ASP内部」で行ってもらい，パラメータをクライアントまで露出させずにASP内に閉じてしまう方法があります．
ただしこれは，ASP対応になるのでコントロール権がなく現実的ではないかもしれません．
（というか「普通」の広告事業者ならやってそうだけど．．．確認しても良いかもです）

もう一案は，ASPの都合上パラメータ書き換え不正をシステムで防ぐのは無理なので，運用でカバーする方法です．
例えば，定期的にASPのCV履歴とECナビのポイント付与履歴を付け合わせチェックする方法です．
こちらは事後チェックになってしまうので「防止」はできませんが，後で不正ユーザにファクトを突きつけることで，不正に持ち出されたポイントを救うことができます．

もちろん，対応の前にリスク評価（攻撃成功率と起きたときの想定被害）と現在の状況把握が必要になります．
なんか小難しくてウアーという感じですが，自分ならとりあえず手を動かす前に，案2の付け合わせチェックを行って現状把握をすると思います．

最後に何かしらの対応を行ったら，実際に不正が減ったかどうかを判断するために，不正観測の仕組みが必要になります．

今回作成したシステムでは，CVパラメータが違う場合にSlack通知をしていますが，まさにそんな感じです．
ただし，今回のアラートが逆の意味で安心バイアスにならないように注意する必要があります．
（先ほど例に上げたパラメータ書き換え不正をスルーしちゃうなど）

なので，不正観測では実際に攻撃を受ける値も直接観測するのが良いです．

今回だとECナビポイントと，ECナビポイントの因果関係にあたる値をウォッチするのがベターだと思います．
因果関係だと，まさに今回作成したトラッキングログは有用だと思います．

ちなみに不正観測に銀の弾丸はありません．というかかなりドロくさいです．
関連する様々な情報を付け合わせながら試行錯誤が必要なので，ここは本当に答えが無いし難しいポイントです．
なので自分も「これを見なさい」というピンポイントなアドバイスは出来ませんし，むしろECナビメンバーの方が多くの知見があると思うので，ぜひ相談してみてください．

いくつかの指標を観測したら，そこから不正の匂いを嗅ぎ分ける必要があります．
ここでのポイントは「正常系を把握する」ことです．
Zucksアフィで大量にクリックが起きる不正（？）があるのですが，これも一般ユーザのクリックの動きを知っているからこそ判断できる技です．
ECナビだと一般ユーザの案件消化傾向や，高額案件の消化傾向が参考になるかもしれません．

## まとめ

今回は「不正対策」というビジネスにとってクリティカルな対応だったので，あえて広い視点でのアドバイスになっています．

実際お仕事は丁寧で素晴らしかったですし，スコープを狭めれば「当時」の問題を解決しているように見えます．

ただし，不正はビジネスリスク案件なので，当事者意識を今以上に持って臨めるとさらによかったです！
そうすると，今回お伝えしたパラメータ書き換え不正も事前に察知して，さらに踏み込んだ対策案が出てきたかもしれません．

開発時のコミュニケーションはバッチリだったので，今度はECナビの様々なメンバーと「不正」に対して議論を深めて行けると良いと思いました．

## コードの細かいやつ

* EcnaviAffiTrackingPeerクラスはEcnaviConnectionをクラスプロパティに持ってインスタンス化して使う方がよい

[EcnaviAffiTrackingPeerクラス](https://github.com/voyagegroup/ecnavi/pull/9638/files#diff-bdfc5378c6922f176b38e3abd9417a9b3f9b0e34191c08bcc00b98cad3269e73R20)

static関数群でヘルパークラスっぽく使っていますが，そもそもこのクラスはDBコネクションが無いと使えないクラスです．
EcnaviConnectionをクラスプロパティにして，このクラスを使う時はコンストラクタで突っ込んでインスタンス化してあげたいですね．
そうすると，EcnaviConnectionのstatic関数依存がこのクラスから消えるので，テストもしやすくなります．

ただし，このコードはECナビの慣例に従っているだけだと思いました．

たぶん [EcnaviBasePeer.php](https://github.com/voyagegroup/ecnavi/blob/c1edfa0f0315ed856a1fe05bf9be8b219db77e27/lib/common/ecnavi_model/EcnaviBasePeer.php) の設計が大元かな．

（というかこの親クラスは単なる差分プログラミングなので，無理に継承しなくても良さそうにみえる）

なので，良い設計では無いという事はぜひ認識していただけると嬉しいです！

* 暗黙の型変換に頼るコードは避ける

https://github.com/voyagegroup/ecnavi/pull/9638/files#diff-4d889f7cb906a18a81c6868ee9776c1d6e18d02071119200e590ddaa310846dfR49

自分だと，ここは `if ($itemId === 0)` と書きますね．

ここはintキャストされた値のチェックなので，実際は `$itemId = 0` の時に404となるコードです．
自分は他の人にも意図が伝わるように， 暗黙の型変換が入ってしまう `!$itemId` は，真のbool値以外では使わないようにしています．
もちろん「意図していない値が通過する」恐れもあるので，なるべく暗黙の型変換は避けていきましょう！

ちなみに (int) も暗黙の型変換が入るので，GETクエリのvalidationがこれでいいのかは気になりますが，そこまでコードを追ってないのでメモ程度に受け取って頂ければ幸です．

