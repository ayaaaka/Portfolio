# 技術力評価会　評価結果

* 被評価者: VM 小林 彩花
* 評価者: Zucks 大島 一将

[評価資料](./21st-2nd-half/vm_a-kobayashi/README.md)

初めての評価会おつかれさまでした．
評価会中は結構緊張されている感じがしたので，もし評価者から変な威圧感出てました的な話であればごめんなさいmm
ジュエルさんも自分もやさしいお兄さん（おじさん）なので，評価会で腹落ち仕切らなかったことがあれば，いつでも気軽にご相談ください！

## 総評

今回はAFFIT経由で行っていたゴシガルキャンペーンをECナビAPI連携にしたお話でした．

まず，売上先月比約30倍（3万円 ⇒ 110万円）はすさまじい功績です．粗利比率やECナビ全体売上に対する割合はちゃんと聞いていなかったのですが，インパクトのある素晴らしい成果だと思います．

運用チームやfluctへのヒアリングはとても丁寧に感じました．ヒアリング結果や検討事項を細かくissueに残しており素晴らしかったです．情報共有をしっかり行うというのはチーム開発で非常に重要なスキルなので，これからも頑張ってください．

アピールポイントであったリリーススケジュールも，既存サービスに影響が出ない方法を選べていたと思います．特にリリース手順を3パターン出して検討・相談した，という動きは良かったです．本番テストを行いながらAFFIT経由での売上はギリギリまで確保しつつ，確認出来たらキャンペーン開放というのは妥当に思えました．ただ，いうても社内サービス同士の連携だし売上も元々「数万円 / 月」程度だったので，一番安全なAFFITを止めて本番テスト～リリースでも案外よさそうに思えました．

ビジネス把握については，AFFITを使うことによる既存の課題を理解できていたと思います．既存の仕組みが色々絡み合っているので大変だったと思いますが，結果売上が爆上がりなので良かったです．

一方で，施策を行う前のビジネス把握・分析はもう少し深堀ることができたのではないかと感じました．「的確に課題を捉え，それに対して妥当な施策を行う」という意識は，今後小林さんが再現性を持って成果を出すために重要な視点です．（良く分からないけど大失敗 or たまたまラッキーパンチ，みたいな行き当たりばったりを避ける為にも）

ただし，今回は既存の仕組み上致し方ない部分な気がするので，今はあまり深刻に考えず，仕事を重ねていく中でさらなるビジネス理解を深めていってください．

このように既存の仕組みを踏襲して進めることは出来ましたが，技術的な質問の節々でフワっとした回答を見受けました．今回は「技術理解」まわりをメインにアドバイスします．

### 良かった点

ヒアリングや検討，相談のタイミングや粒度など「仕事の進め方」に関しては安心して任せられるレベルだと感じました．

- 既存の仕組みに沿って，丁寧に開発を進めていました
- ヒアリング結果や相談など，細かくissueに残せていました
- チーム外のメンバー（fluct）と上手くコミュニケーションを取りながらお仕事ができていました
- リリース計画は複数案出して検討できていました
- インデックス検討で実際に大量データをINSERTするなど，手を動かして確認・検証を行っていた
    - それがベターかどうかは色々ありますが，事実を確認しようという動きはとても素晴らしいですし，エンジニアにとって重要なスキルの一つです

これは小林さん個人というよりチームに対してですが，PRのコメントがとても丁寧で素晴らしかったです．自分なら口頭でサーっと済ませる内容が，ちゃんとPRに残っています．

https://github.com/voyagegroup/ecnavi/pull/8227#discussion_r309567245  
https://github.com/voyagegroup/ecnavi-db/pull/437

これはまさに天然物のECナビ教材だと思うので，今後新しく来る新卒や新メンバーのためにも，いい感じに引けるようにまとめておくと良さそうです．

### 気になった点

- 技術的な質問で，あやふやな箇所があった
    - 評価会中に「テーブルのPKがサロゲートキーとcreated_atになっているのはなぜですか？」と意地悪な質問もしましたが，各所でぽつぽつと技術の理解不足を感じました
    - パーティション計画は，先輩の話は聞いたけど自分の中で租借しきれなかったかな，と感じました
    - テストは先輩方に色々相談していて素晴らしかったですが，惜しいことに「結局何を ` テスト ` したいんだっけ」という本質まで到達しきれていませんでした

## 成長へのアドバイス

既存の仕組みや取り組み自体に若干の悩ましさを感じましたが，結構しょうがない部分もあるので「妥当かな」という感想です．もちろんビジネス理解や課題認識力は重要ですが，まずは事業を支える為の技術スキル向上を目指すのが良いと感じました．

今回のように振られた仕事範囲からで十分なので，小林さんから率先して技術的な意味，システム設計の意図と未来像を先輩方から聞き出してみてください．それを積み重ねることで，おのずと先人達の経験が自分に蓄積され，ある瞬間から「こういうことだったのか」と一気に視野が広がると思います．

ちなみになぜ未来像とセットなのかというと，今動いているシステムの設計やコードが正解ではないからです．先輩方からすでに聞いていると思いますが，ECナビには改善の余地がある設計やコードが多く眠っています．小林さんが一生懸命コードリーディングをして「こうすればいいのか！」と腹落ちしても，結局バッドノウハウを身につけてしまう危険性があります．

とはいえ全然技術力が無いという話ではなく，もちろん勘所は悪くないです．先輩達のPRレビューのおかげもあり，今回の仕事でどんどん成長しているなと強く感じました．なので指摘されたタイミングで少しずつ，ただし正確な技術把握を心がけて下さい．

技術理解＆説明がしっかりできるようになれば，自分なら安心してこれぐらいの規模の仕事はマルっと投げちゃいます．

--

## 具体的でこまかいの色々

- インデックスの検討

https://github.com/voyagegroup/ecnavi-db/pull/437#issuecomment-521935680

```
# 小林さん談

ダミーデータを10万件入れてINDEX張りまくって違いを比較した。
でも、結局は量だけでなく中に入ってくるデータ、クエリによってパフォーマンスが変わるからシミュレーション仕切るのは難しい
throwQueryになりそうだったら変える作戦で、想定できる状況から一番効率良さそうなものに貼った。
```

データを突っ込んでインデックス性能を確認したのは良かったですが， ` 検討 ` はデータを入れる前にできる話です．駒崎さんも[節々でコメント](https://github.com/voyagegroup/ecnavi-db/pull/437)していますが，SELECT条件のカラムに対してインデックスを検討するのが王道です．条件カラムのカーディナリティ（値の種類）が十分に高ければ，インデックスを貼る価値があります．あとはDBMS固有の話もポツポツありますが，メインはSELECT条件になるカラムなので，次回以降意識してみてください．

- テストの名前が抽象的すぎる

根本原因として「何をテストすると嬉しいんだっけ」があると思います．テストについては評価会やSlackでもポツポツお話しましたが，この後参考書籍も上げておいたのでぜひ読んでみてください．

https://github.com/voyagegroup/ecnavi/blob/master/sites/ecnavi/apps/test/phpunit/controller/api/GgtalkControllerTest.php#L40

「testExecuteIndex_正しい例」はかなりザックリしています．「正しい」ということは具体的にどういうことなのか，まで落とし込んで名前を付けられると良いです．ざっくりしているので，例えばリグレッション時に「 ` testExecuteIndex_正しい例 ` がコケたけど，結局なんだろねコレ」と，テストコード自体を読み解き始めるというツライ状況になるかもしれません．

例えば自分なら「testExecuteIndex_jsonデータがPOSTされたら，PointGrantServiceのsaveが一回呼び出されること」と書くかもしれません．

- パラメタライズドテスト

https://github.com/voyagegroup/ecnavi/blob/master/sites/ecnavi/apps/test/phpunit/controller/api/GgtalkControllerTest.php#L23-L28

APIのbodyが1種類で固定ですが，たとえば「action_atの日付フォーマットがおかしかったら？」等々のテストが欲しそうに見えました（これは，Validatorクラスの方でテストしてるかもですが）．PHPUnitではDataProviderという仕組みを使ってパラメタライズドテストを行うことが出来ます．例えば1つのアサーション（bodyが正しければ200を返す，とか）に対して，アサーションを満たす条件のパラメータをいくつもまとめることができます．特に境界値テストで威力を発揮するので，もし必要なタイミングが出てきたら検討してみてください．

https://phpunit.readthedocs.io/ja/latest/writing-tests-for-phpunit.html#writing-tests-for-phpunit-data-providers-examples-datatest-php

ちなみにDataProviderを使う上での注意として，必ず1アサーションを満たす単位にまとめるよう心がけてください．DataProvider自体が複数アサーション条件（たとえば正しいbodyと間違ったbody）を持ってしまうと，テストメンテナンス性が悪くなるので避けてください．

- バリデーションに通らないは，例外なんだっけ？

（ECナビでは「バリデーション失敗は必ず例外にすること」が前提になっているかもしれないですが，今回そこまで追えてないですゴメンナサイmm）

https://github.com/voyagegroup/ecnavi/blob/master/sites/ecnavi/apps/lib/ggtalk/Validator.php#L40-L42

validメソッドは「引数の値がOKかNGか」を調べるメソッドなので，NGの場合に ` 検査例外 ` を返すのはあまりよいインタフェースとは言えません．[例外](https://ja.wikipedia.org/wiki/%E4%BE%8B%E5%A4%96%E5%87%A6%E7%90%86)は「validメソッドに対して処理不能な例外的事由」で投げるべきであり，お仕事範囲である「バリデーションの結果NG」はreturnで返して上げるのが良いです．一番シンプルなのはfalseを返して上げるパターンで，失敗理由も返したい場合は「失敗すれば理由の配列，成功すれば空配列」みたいなパターンもできます．

（ちなみに[他のFW](https://github.com/symfony/symfony/tree/master/src/Symfony/Component/Validator)だと，validate結果をクラスにしています）

そもそも例外は「大域脱出機能」なので，使い方を注意しないととても追いずらいコードになってしまいます．ライブラリはともかく，自前プロダクトで ` 検査例外 ` を選択する機会はそう多くないはずです．

ちなみに[この例外](https://github.com/voyagegroup/ecnavi/blob/master/sites/ecnavi/apps/lib/ggtalk/Validator.php#L81-L83)はGOODです．バリデーションルールがないというのはコーディングをミスっているということなので， ` 非検査例外（PHPではLogicException） ` として扱ったのは妥当です．これはユニットテストで開発時に発見できるので，テスト込みで運用できているとなお良しです．

- 依存はなるべく切り離しましょう

https://github.com/voyagegroup/ecnavi/blob/master/sites/ecnavi/apps/lib/ggtalk/PointGrantService.php#L11-L15

ValidatorとDAOをコンストラクタで差し込んでいますが，引数がnullだと直接生成している箇所は「うーん，おしい」でした．特にDaoFactoryに依存しているのは，後々禍根を残すかもしれません．例えばDaoFactoryに何か変更が加わるたびに，本当は関係ないはずのEcnavi_Ggtalk_PointGrant_Serviceがひっそりと壊れる可能性があります．

このコードを読む限り2つの意図を推測出来たのですが，どちらでも解決策は同じです．

> 「Ecnavi_Ggtalk_PointGrant_Serviceをnewする際に，nullが来てしまうかもしれない」

null許容は外して，単にプロパティセットだけしましょう．

newする側の責務なので，Ecnavi_Ggtalk_PointGrant_Serviceでお尻拭きをするのはあまり良い解決策ではないです．newする側で適切にエラーハンドリングする感じが良いです．

> 「newの時にラクできるようにした」

null許容は外して，単にプロパティセットだけしましょう．

ちょっとしたコーディングの手間を省くために，後々禍根を残す依存をコンストラクタに埋め込むのは悪手です．newする側は素直にValidatorとDAOをセットするようにしましょう．

https://github.com/voyagegroup/ecnavi/blob/master/sites/ecnavi/apps/lib/ggtalk/PointGrantService.php#L47

ここも，出来ることならコンストラクタで外から貰う形になっているとよいです．


ちなみにここなへんの指摘は，SOLID原則と呼ばれる設計のお話が絡んでいます．この評価結果でモリモリ説明しだすと大変なことになるので，ぜひ先輩や自分とかに聞いてみてください！

- [バリデーションだと思うので，validにまとめられるとよさそうです](https://github.com/voyagegroup/ecnavi/blob/master/sites/ecnavi/apps/lib/ggtalk/PointGrantService.php#L35-L37)

- getPointByDeviceやロギングはtry-catchの外が良さそうです

https://github.com/voyagegroup/ecnavi/blob/master/sites/ecnavi/apps/lib/ggtalk/PointGrantService.php#L52-L67

先ほどのvalid例外まわりの話に絡みますが，try-catchは必要な箇所だけ小さく保つようにすると処理を把握しやすくなります．

- Oracleのロールバックに失敗して例外出た場合，MySQL側のロールバック大丈夫かな？

https://github.com/voyagegroup/ecnavi/blob/master/sites/ecnavi/apps/lib/ggtalk/PointGrantService.php#L73

「EcnaviDatabase::getConnectionでPDOそのまま返ってくるなら例外でるよなーと思いつつ， ` rollBack() ` ではなく ` rollback() ` なのでもしかしたら．．．？」と，EcnaviDatabase探そうとしましたが諦めましたゴメンナサイ．

### テストについてオススメの本＆ブログ

「テスト悩みました！」とのことなので，ちょろっとだけ紹介しますmm

- [テスト駆動開発](https://www.amazon.co.jp/dp/B077D2L69C/)

TDDを業務で使うかどうかは別にして，どういった点に気を付けてテストを書けば良いのかを実際のコードベースで学ぶことができます．（Javaですが，文法はPHPに似ているので読めると思います）

「第25章テスト駆動開発のパターン」に「テストとは」というお話も乗っているので，ぜひ目を通しておくと色々気づきがあると思います．

「付録C 訳者解説：テスト駆動開発の現在」には，TDDを学ぶ意味と学習の仕方について書いてあります．TDDに留まらない学習姿勢全般に当てはまるお話なので，自分も大いに影響を受けました．（t-wadaさんはVGにいらっしゃるので，直接お話を伺うのもオススメです！）

- https://martinfowler.com/articles/practical-test-pyramid.html

テストピラミッドの下から上までを順序立てて解説しており，網羅的に確認できるのでオススメです．もし英語が苦手でしたら全文Google翻訳がオススメです．（プログラムコードも翻訳されて面白いことになるけど）

